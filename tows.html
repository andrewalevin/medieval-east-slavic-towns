<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ä—É—Å—Å–∫–∏–µ –≥–æ—Ä–æ–¥–∞</title>

    <!-- Mapbox GL JS (latest 3.x) -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet"/>

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont,
            "Segoe UI", Roboto, Ubuntu, sans-serif;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .popup {
            max-width: 380px;
            font-size: 14px;
            line-height: 1.45;
        }

        .popup h3 {
            margin: 0 0 6px;
            font-size: 18px;
        }

        .popup img {
            width: 100%;
            border-radius: 6px;
            margin: 8px 0;
        }

        .section {
            margin-top: 10px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chronicle {
            color: #555;
            font-size: 12px;
            margin-left: 8px;
        }

        .mapboxgl-popup-content {
            font-family: 'Inter', sans-serif;
            padding: 12px 16px;
            background: rgba(30, 30, 30, 0.8);
            color: #f1faee;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

<div id="map"></div>

<script>

    // üîë –¢–æ–∫–µ–Ω
    mapboxgl.accessToken = "pk.eyJ1IjoiYW5kcmV3bGV2aW4iLCJhIjoiY2t5ZXM5c3cyMWJxYjJvcGJycmw0dGlyeSJ9.9QfCmimkyYicpprraBc-XQ";

    // üåê JSON —Å —Å–µ—Ä–≤–µ—Ä–∞
    const DATA_URL =
        "towns-without-dates.json";

    // —Å–ª–æ–≤–∞—Ä—å —Ü–≤–µ—Ç–æ–≤
    const colorsTownsKingdoms = {
        "–±–æ–ª–≥–∞—Ä—Å–∫–∏–π": "SeaGreen",
        "–≤–∞–ª–∞—à—Å–∫–∏–π": "DeepPink",
        "–≤–æ–ª—ã–Ω—Å–∫–∏–π": "LimeGreen",
        "–∑–∞–ª–µ—Å—Å–∫–∏–π": "green",
        "–∫–∏–µ–≤—Å–∫–∏–π": "blue",
        "–ª–∏—Ç–æ–≤—Å–∫–∏–π": "red",
        "–ø–æ–¥–æ–ª—å—Å–∫–∏–π": "DarkTurquoise",
        "—Ä—è–∑–∞–Ω—Å–∫–∏–π": "Orange",
        "—Å–º–æ–ª–µ–Ω—Å–∫–∏–π": "Fuchsia",
        "—Ç–≤–µ—Ä—Å–∫–æ–π": "DodgerBlue"
    };

    // —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –ø–æ –∫–ª—é—á—É
    function getColorKingdom(key) {
        return colorsTownsKingdoms[key] || "black"; // –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ—Ä–Ω—ã–π
    }


    // ----------------------------
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    // ----------------------------
    const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/light-v11",
        center: [30, 55],
        zoom: 4,
        projection: "mercator"
    });

    map.addControl(new mapboxgl.NavigationControl());


    function getThumbnailURL(originalURL, width) {
        // –†–∞–∑–¥–µ–ª—è–µ–º URL –Ω–∞ —á–∞—Å—Ç–∏
        const parts = originalURL.split('/');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ URL –∫ —Ñ–∞–π–ª—É –≤ Wikimedia Commons
        if (!originalURL.includes('upload.wikimedia.org')) {
            throw new Error('–≠—Ç–æ –Ω–µ —Å—Å—ã–ª–∫–∞ Wikimedia Commons');
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        const fileName = parts[parts.length - 1];

        // –í—Å—Ç–∞–≤–ª—è–µ–º "thumb" –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Ç—Ä–µ–º—è —á–∞—Å—Ç—è–º–∏
        // –ü—Ä–∏–º–µ—Ä: [..., 'wikipedia', 'commons', '1', '14', 'Chukhloma_0801.jpg']
        const thumbParts = [...parts];
        thumbParts.splice(parts.length - 3, 0, 'thumb');

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—É
        const thumbURL = `${thumbParts.join('/')}/${width}px-${fileName}`;
        return thumbURL;
    }

    // ----------------------------
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    // ----------------------------
    fetch(DATA_URL)
        .then((r) => r.json())
        .then((data) => {
            const features = [];

            data.forEach((entry) => {
                entry.modern_cities.forEach((city) => {
                    if (!city.coords || city.coords.lat == null) return;

                    features.push({
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: [city.coords.lon, city.coords.lat]
                        },
                        properties: {
                            name: city.name,
                            image: city.image_640,
                            wiki: city.wiki_url,
                            foundation: city.foundation,
                            origin_type: entry.origin_type,
                            historical_names: entry.historical_names,
                            color: getColorKingdom(entry.origin_type)
                        }
                    });
                });
            });

            console.log(features);

            const geojson = {
                type: "FeatureCollection",
                features
            };

            map.on("load", () => {

                map.addLayer({
                        id: 'rivers-glow',
                        type: 'line',
                        source: 'composite',
                        'source-layer': 'waterway',
                        paint: {
                            'line-color': '#0099ff',
                            'line-width': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                4, 3,
                                12, 10
                            ],
                            'line-opacity': 0.25
                        }
                    },
                    'rivers-bright'
                );

                map.addSource("cities", {
                    type: "geojson",
                    data: geojson
                });

                // üî¥ –¢–æ—á–∫–∏
                map.addLayer({
                    id: "city-points",
                    type: "circle",
                    source: "cities",
                    paint: {
                        "circle-radius": 6,
                        "circle-color": ["get", "color"],
                        "circle-stroke-width": 1.5,
                        "circle-stroke-color": "#ffffff"
                    }
                });

                // üè∑ –ü–æ–¥–ø–∏—Å–∏
                map.addLayer({
                    id: "city-labels",
                    type: "symbol",
                    source: "cities",
                    layout: {
                        "text-field": ["get", "name"],
                        "text-font": ["Open Sans Semibold"],
                        "text-offset": [0, 1.2],
                        "text-anchor": "top",
                        "text-size": 12
                    },
                    paint: {
                        "text-color": "#333"
                    }
                });

                // ----------------------------
                // Popup
                // ----------------------------
                const layersIdsToClick = ['city-labels', "city-points"];


                map.on("click", layersIdsToClick, (e) => {
                    const feature = e.features[0];
                    const p = feature.properties;
                    const coords = feature.geometry.coordinates.slice();

                    const historical =
                        typeof p.historical_names === "string"
                            ? JSON.parse(p.historical_names)
                            : p.historical_names;

                    let html = `<div class="popup"><h3>${p.name}</h3>`;

                    if (p.image) {
                        const thumbURL = getThumbnailURL(p.image, 500); // –º–∏–Ω–∏–∞—Ç—é—Ä–∞ —à–∏—Ä–∏–Ω–æ–π 300px
                        html += `<img src="${thumbURL}" alt="${p.name}">`;
                    }

                    if (p.foundation) {
                        html += `
                          <div class="section">
                            <div class="section-title">–û—Å–Ω–æ–≤–∞–Ω–∏–µ</div>
                            <div>${p.foundation.text}</div>
                          </div>`;
                    }

                    html += `
                        <div class="section">
                          <div class="section-title">–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</div>
                          <div>${p.origin_type}</div>
                        </div>

                        <div class="section">
                          <div class="section-title">–ù–∞–∑–≤–∞–Ω–∏—è –≤ –ª–µ—Ç–æ–ø–∏—Å—è—Ö</div>`;
                            historical.forEach((h) => {
                                html += `
                                  <div>
                                    ${h.name}
                                    ${h.chronicle ? `<div class="chronicle">${h.chronicle}</div>` : ""}
                                  </div>`;
                            });
                    html += `</div>`;

                    if (p.wiki) {
                        html += `
                          <div class="section">
                            <a href="${p.wiki}" target="_blank">–°—Ç–∞—Ç—å—è –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏ ‚Üí</a>
                          </div>`;
                    }

                    html += `</div>`;

                    new mapboxgl.Popup({ maxWidth: "400px" })
                        .setLngLat(coords)
                        .setHTML(html)
                        .addTo(map);
                });

                // UX
                map.on("mouseenter", layersIdsToClick, () => {
                    map.getCanvas().style.cursor = "pointer";
                });
                map.on("mouseleave", layersIdsToClick, () => {
                    map.getCanvas().style.cursor = "";
                });
            });
        })
        .catch((err) => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:", err);
        });

</script>

</body>
</html>